<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <title>Document</title>
</head>

<style>
  * {
    box-sizing: border-box;
    font-family: sans-serif;
    color: #141414;
  }

  body {
    background-color: #fff;
    max-width: 800px;
    margin: auto;
    padding: 20px;
  }

  ul {
    list-style: none;
    padding: 4px 8px;
    margin: 0;

    li {
      display: flex;
      align-items: center;
      gap: 4px;
    }
  }

  .panel-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px 20px;
  }

  .panel {
    display: flex;
    flex-direction: column;
    gap: 4px;

    h2 {
      margin: 0;
    }

    .input-row {
      display: flex;
      gap: 4px;
      align-items: center;

      input {
        flex: 1;
        padding: 4px;
      }
    }

    .scroll-window {
      height: 8rem;
      border: 1px solid #8f8f9c;
      overflow: scroll;

      button {
        border: none;
        background-color: #ffaaaa;
        border-radius: 50%;
        padding: 1px 4px;
        text-align: center;
        font-weight: bold;

        &:hover {
          background-color: #ffcccc;
        }
      }
    }

  }

  .window-panel {
    grid-column: 1/3;
  }

  #chat-display div,
  #data-display div {
    padding: 4px 8px;

    &:nth-child(odd) {
      background-color: #eee;
    }
  }

  .controls-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
  }

  .controls-panel {
    display: flex;
    flex-direction: column;
    gap: 20px;

  }

  .control {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 60px;

    input[type="text"] {
      padding: 4px;
    }

    button {
      width: 40px;
      height: 20px;
      margin: 2px;
      font-weight: bold;
    }
  }

  @media (max-width: 480px) {
    .panel-grid {
      grid-template-columns: 1fr;
    }

    .window-panel {
      grid-column: 1;
    }

    .panel {
      .input-row {
        flex-direction: column;
        align-items: flex-start;

        input {
          width: 100%;
        }
      }
    }
  }

  @media (max-width: 678px) {
    .panel:not(.window-panel) {
      .input-row {
        flex-direction: column;
        align-items: flex-start;

        input {
          width: 100%;
        }
      }
    }
  }
</style>

<body>

  <div x-data="{
    setUsername(username) {
      setUsername(username)
    },
    toggleFeed(username) {
      toggleFeed(username)
    },
    toggleRoom(room) {
      toggleRoom(room);
    },
    createRoom(room) {
      createRoom(room);
    },
    deleteRoom(room) {
      deleteRoom(room);
    },
    chat(msg) {
      chat(msg);
    },
    sendToServer(msg) {
      sendToServer(msg);
    },
    textToOsc(text) {
      const firstSpaceIndex = text.indexOf(' ');
      if (firstSpaceIndex === -1) {
        const msg = { address: text, args: [] };
        sendToServer(msg);
        return;
      }
      const address = text.substring(0, firstSpaceIndex);
      const argsString = text.substring(firstSpaceIndex + 1);
      const args = argsString.split(' ').map(item => {
        const num = Number(item);
        return isNaN(item) ? item : num;
      });
      const msg = { address, args };
      sendToServer(msg);
    }
  }">

    <div class="panel-grid">
      <div class="panel">
        <h2>Users</h2>
        <div class="scroll-window">
          <ul>
            <template x-for="username in $store.ch.users" :key="username">
              <li x-show="$store.ch.username !== username">
                <input type="checkbox" @click.prevent="toggleFeed(username)"
                  :checked="$store.ch.myFeeds.includes(username)">
                <span x-text="username"></span>
              </li>
            </template>
          </ul>
        </div>
        <div class="input-row">
          <label for="username-input">Set username:</label>
          <input type="text" name="username-input" :placeholder="$store.ch.username"
            @change="setUsername($el.value); $el.value = ''">
        </div>
      </div>

      <div class="panel">
        <h2>Rooms</h2>
        <div class="scroll-window">
          <ul>
            <template x-for="room in $store.ch.rooms" :key="room">
              <li>
                <input type="checkbox" @click.prevent="toggleRoom(room)" :checked="$store.ch.myRooms.includes(room)">
                <span x-text="room"></span>
                <button @click="deleteRoom(room)">x</button>
              </li>
            </template>
          </ul>
        </div>
        <div class="input-row">
          <label for="room-input">Create new room:</label>
          <input type="text" name="room-input" @change="createRoom($el.value); $el.value = ''">
        </div>
      </div>


      <div class="panel window-panel">
        <h2>Chat</h2>
        <div class="scroll-window" id="chat-display" style="height: 8rem; border: 1px solid black; overflow: scroll;">
        </div>
        <div class="input-row">
          <label for="chat-input">Send chat:</label>
          <input type="text" name="chat-input" @change="chat($el.value); $el.value = ''">
        </div>
      </div>

      <div class="panel window-panel">
        <h2>Data Monitor</h2>
        <div>Latest data messages received (10)</div>
        <div class="scroll-window" id="data-display">
          <template x-for="(data, index) in $store.ch.dataFeed" :key="index">
            <div x-text="data"></div>
          </template>
        </div>
        <div class="input-row">
          <label for="data-input">Send data:</label>
          <input type="text" name="data-input" placeholder="/broadcast/testing 1 2 3"
            @change="textToOsc($el.value); $el.value = ''">
        </div>
      </div>

    </div>


    <div x-data="{
      buttonsArray: [],
      slidersArray: [],
      togglesArray: [],
      sendToServer(msg) {
        sendToServer(msg)
      },
      init() {
        const paramsString = window.location.search;
        const searchParams = new URLSearchParams(paramsString);
        const buttonsQuery = searchParams.get('buttons') || 0;
        for (let i = 0; i < buttonsQuery; i++) {
          this.buttonsArray.push(`button${i+1}`);
        }
        const slidersQuery = searchParams.get('sliders') || 0;
        for (let i = 0; i < slidersQuery; i++) {
          this.slidersArray.push(`slider${i+1}`);
        }
        const togglesQuery = searchParams.get('toggles') || 0;
        for (let i = 0; i < togglesQuery; i++) {
          this.togglesArray.push(`toggle${i+1}`);
        }
      }
    }">
      <div x-show="buttonsArray.length || slidersArray.length || togglesArray.length">
        <h2 style="margin: 40px 0 20px 0;">Controls</h2>
        <div class="controls-container">
          <div class="controls-panel">
            <template x-for="button in buttonsArray" :key="button">
              <div x-data="{ address: `/broadcast/${button}` }" class="control">
                <input type="text" :placeholder="address" @change="address = $el.value; $el.value = ''">
                <button @click="sendToServer({ address, args: []})"></button>
              </div>
            </template>
          </div>
          <div class="controls-panel">
            <template x-for="slider in slidersArray" :key="slider">
              <div x-data="{ address: `/broadcast/${slider}` }" class="control">
                <input type="text" :placeholder="address" @change="address = $el.value; $el.value = ''">
                <input type="range" @input="sendToServer({ address, args: [Number($el.value)]})">
              </div>
            </template>
          </div>
          <div class="controls-panel">
            <template x-for="toggle in togglesArray" :key="toggle">
              <div x-data="{ address: `/broadcast/${toggle}` }" class="control">
                <input type="text" :placeholder="address" @change="address = $el.value; $el.value = ''">
                <input type="checkbox" @change="sendToServer({ address, args: [$el.checked ? 1 : 0]})">
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>


    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.store('ch', {
          username: '',
          users: [],
          rooms: [],
          myFeeds: [],
          myRooms: [],
          dataFeed: []
        });
      });

      //

      const query = {};
      const paramsString = window.location.search;
      const searchParams = new URLSearchParams(paramsString);
      const usernameQuery = searchParams.get("username");
      const roomsQuery = searchParams.get("rooms");

      if (usernameQuery) query.username = usernameQuery;
      if (roomsQuery) query.rooms = roomsQuery;

      const socket = io({
        query
      });

      socket.on('connect', () => {});

      socket.on('init', data => {
        Alpine.store('ch').username = data.username;
        Alpine.store('ch').users = data.users;
        Alpine.store('ch').rooms = data.rooms;
        Alpine.store('ch').myRooms = data.myRooms;
      });

      socket.on('msg', msg => {
        dataFeed(msg);
        if (window.max) {
          window.max.outlet(msg.address, ...msg.args);
        } else if (window.electronAPI) {
          window.electronAPI.onSocketMessage(msg);
        }
      });

      socket.on('chat', incoming => {
        const userEl = document.createElement('span');
        userEl.textContent = `${incoming.username}: `;
        userEl.style.setProperty('font-weight', 'bold');
        const msgEl = document.createElement('span');
        msgEl.textContent = incoming.msg;
        const msgContainer = document.createElement('div');
        msgContainer.appendChild(userEl);
        msgContainer.appendChild(msgEl);
        const chatDisplay = document.getElementById('chat-display');
        chatDisplay.appendChild(msgContainer);
        chatDisplay.scrollTo({
          top: chatDisplay.scrollHeight,
          behavior: 'smooth'
        });
      });

      socket.on('confirm-username', username => {
        Alpine.store('ch').username = username;
      });

      socket.on('user-list', users => {
        Alpine.store('ch').users = users;
      });

      socket.on('room-list', rooms => {
        Alpine.store('ch').rooms = rooms;
      });

      socket.on('my-feeds', feeds => {
        Alpine.store('ch').myFeeds = feeds;
      });

      socket.on('my-rooms', rooms => {
        Alpine.store('ch').myRooms = rooms;
      });

      socket.on('connect_error', (error) => {
        alert(`Error: ${error.message}`);
      });

      socket.on('disconnect', () => {
        Alpine.store('ch').username = '';
        Alpine.store('ch').users = [];
        Alpine.store('ch').rooms = [];
        Alpine.store('ch').myFeeds = [];
        Alpine.store('ch').myRooms = [];
      });

      function setUsername(username) {
        socket.emit('set-username', username);
      }

      function toggleFeed(username) {
        socket.emit('toggle-feed', username);
      }

      function toggleRoom(room) {
        socket.emit('toggle-room', room);
      }

      function createRoom(room) {
        socket.emit('create-room', room);
      }

      function deleteRoom(room) {
        if (confirm(`Are you sure you want to force delete "${room}" room? There may be other people using it.`)) {
          socket.emit('delete-room', room);
        }
      }

      function chat(msg) {
        socket.emit('chat', msg);
      }

      function sendToServer(msg) {
        if (!msg.address.startsWith('/broadcast') &&
          !msg.address.startsWith('/feed') &&
          !msg.address.startsWith('/room') &&
          !msg.address.startsWith('/user')) {
          return;
        }
        socket.emit('msg', msg);
      }

      function dataFeed(msg) {
        const data = `${msg.address} ${msg.args.join(' ')}`;
        Alpine.store('ch').dataFeed.push(data);
        if (Alpine.store('ch').dataFeed.length > 10) {
          Alpine.store('ch').dataFeed.shift();
        }
      }

      if (window.max) {
        window.max.bindInlet('ch', (...list) => {
          const msg = {
            address: list[0],
            args: list.slice(1)
          }
          sendToServer(msg);
        });
      } else if (window.electronAPI) {
        window.electronAPI.onOscMessage(msg => {
          sendToServer(msg);
        });
      }
    </script>
</body>

</html>